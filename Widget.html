
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>CRAV AI Widget</title>
  <style>
    /* Widget Styles */
    .crav-widget {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
      position: fixed;
      bottom: 20px;
      right: 20px;
      z-index: 999999;
    }

    .crav-bubble {
      width: 60px;
      height: 60px;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      box-shadow: 0 4px 20px rgba(0,0,0,0.15);
      transition: all 0.3s ease;
      border: none;
      outline: none;
    }

    .crav-bubble:hover {
      transform: scale(1.1);
      box-shadow: 0 6px 25px rgba(0,0,0,0.2);
    }

    .crav-bubble svg {
      width: 24px;
      height: 24px;
      fill: white;
    }

    .crav-chat-container {
      position: absolute;
      bottom: 80px;
      right: 0;
      width: 350px;
      height: 500px;
      background: white;
      border-radius: 12px;
      box-shadow: 0 10px 40px rgba(0,0,0,0.1);
      display: none;
      flex-direction: column;
      overflow: hidden;
      border: 1px solid #e1e5e9;
    }

    .crav-chat-container.open {
      display: flex;
      animation: slideUp 0.3s ease-out;
    }

    @keyframes slideUp {
      from { opacity: 0; transform: translateY(20px); }
      to { opacity: 1; transform: translateY(0); }
    }

    .crav-header {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      padding: 16px;
      display: flex;
      justify-content: between;
      align-items: center;
    }

    .crav-header h3 {
      margin: 0;
      font-size: 16px;
      font-weight: 600;
    }

    .crav-close {
      background: none;
      border: none;
      color: white;
      font-size: 20px;
      cursor: pointer;
      padding: 0;
      width: 24px;
      height: 24px;
      display: flex;
      align-items: center;
      justify-content: center;
      margin-left: auto;
    }

    .crav-messages {
      flex: 1;
      overflow-y: auto;
      padding: 16px;
      background: #f8f9fa;
    }

    .crav-message {
      margin-bottom: 12px;
      max-width: 85%;
      word-wrap: break-word;
    }

    .crav-message.user {
      background: #007bff;
      color: white;
      padding: 8px 12px;
      border-radius: 18px 18px 4px 18px;
      margin-left: auto;
      font-size: 14px;
    }

    .crav-message.bot {
      background: white;
      color: #333;
      padding: 8px 12px;
      border-radius: 18px 18px 18px 4px;
      border: 1px solid #e1e5e9;
      font-size: 14px;
      line-height: 1.4;
    }

    .crav-input-area {
      padding: 16px;
      border-top: 1px solid #e1e5e9;
      background: white;
    }

    .crav-auto-cart {
      position: absolute;
      top: 60px;
      right: 370px;
      width: 300px;
      background: white;
      border-radius: 12px;
      box-shadow: 0 10px 40px rgba(0,0,0,0.1);
      border: 1px solid #e1e5e9;
      display: none;
      flex-direction: column;
      max-height: 400px;
      z-index: 999998;
    }

    .crav-auto-cart.show {
      display: flex;
      animation: slideIn 0.3s ease-out;
    }

    @keyframes slideIn {
      from { opacity: 0; transform: translateX(20px); }
      to { opacity: 1; transform: translateX(0); }
    }

    .crav-cart-header {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      padding: 12px 16px;
      border-radius: 12px 12px 0 0;
      font-weight: 600;
      font-size: 14px;
    }

    .crav-cart-items {
      padding: 16px;
      flex: 1;
      overflow-y: auto;
    }

    .crav-cart-item {
      display: flex;
      justify-content: between;
      align-items: center;
      padding: 8px 0;
      border-bottom: 1px solid #f0f0f0;
    }

    .crav-cart-item:last-child {
      border-bottom: none;
    }

    .crav-item-info {
      flex: 1;
      margin-right: 8px;
    }

    .crav-item-name {
      font-weight: 500;
      font-size: 13px;
      color: #333;
      margin-bottom: 2px;
    }

    .crav-item-price {
      font-size: 12px;
      color: #666;
    }

    .crav-item-checkbox {
      margin-right: 8px;
      accent-color: #667eea;
    }

    .crav-cart-actions {
      padding: 16px;
      border-top: 1px solid #e1e5e9;
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    .crav-cart-button {
      background: #667eea;
      color: white;
      border: none;
      border-radius: 6px;
      padding: 10px 16px;
      font-size: 13px;
      font-weight: 500;
      cursor: pointer;
      transition: background 0.2s;
    }

    .crav-cart-button:hover {
      background: #5a6fd8;
    }

    .crav-cart-button.secondary {
      background: #f8f9fa;
      color: #667eea;
      border: 1px solid #e1e5e9;
    }

    .crav-cart-button.secondary:hover {
      background: #e9ecef;
    }

    .crav-cart-total {
      font-weight: 600;
      color: #333;
      margin-bottom: 8px;
      text-align: center;
      font-size: 14px;
    }

    @media (max-width: 480px) {
      .crav-auto-cart {
        right: 10px;
        top: 80px;
        width: calc(100vw - 40px);
      }
    }

    .crav-input-container {
      display: flex;
      gap: 8px;
    }

    .crav-input {
      flex: 1;
      border: 1px solid #e1e5e9;
      border-radius: 20px;
      padding: 8px 16px;
      font-size: 14px;
      outline: none;
      resize: none;
      font-family: inherit;
    }

    .crav-input:focus {
      border-color: #667eea;
    }

    .crav-send {
      background: #667eea;
      color: white;
      border: none;
      border-radius: 50%;
      width: 36px;
      height: 36px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: background 0.2s;
    }

    .crav-send:hover {
      background: #5a6fd8;
    }

    .crav-send:disabled {
      background: #ccc;
      cursor: not-allowed;
    }

    .crav-typing {
      display: flex;
      align-items: center;
      gap: 4px;
      color: #666;
      font-size: 12px;
      font-style: italic;
    }

    .crav-typing-dots {
      display: flex;
      gap: 2px;
    }

    .crav-typing-dots span {
      width: 4px;
      height: 4px;
      background: #666;
      border-radius: 50%;
      animation: typing 1.4s infinite;
    }

    .crav-typing-dots span:nth-child(2) { animation-delay: 0.2s; }
    .crav-typing-dots span:nth-child(3) { animation-delay: 0.4s; }

    @keyframes typing {
      0%, 60%, 100% { opacity: 0.3; }
      30% { opacity: 1; }
    }

    .crav-user-info {
      font-size: 11px;
      color: rgba(255,255,255,0.8);
      margin-top: 2px;
    }

    @media (max-width: 480px) {
      .crav-widget {
        bottom: 10px;
        right: 10px;
      }
      
      .crav-chat-container {
        width: calc(100vw - 20px);
        height: calc(100vh - 100px);
        right: -10px;
      }
    }
  </style>
</head>
<body>
  <div id="crav-widget" class="crav-widget">
    <!-- Chat Bubble -->
    <button class="crav-bubble" onclick="toggleChat()">
      <svg viewBox="0 0 24 24">
        <path d="M20 2H4c-1.1 0-2 .9-2 2v12c0 1.1.9 2 2 2h4l4 4 4-4h4c1.1 0 2-.9 2-2V4c0-1.1-.9-2-2-2zm-2 12H6v-2h12v2zm0-3H6V9h12v2zm0-3H6V6h12v2z"/>
      </svg>
    </button>

    <!-- Chat Container -->
    <div id="crav-chat" class="crav-chat-container">
      <div class="crav-header">
        <div>
          <h3>CRAV AI Assistant</h3>
          <div class="crav-user-info" id="crav-user-info">What are you craving?</div>
        </div>
        <button class="crav-close" onclick="closeChat()">Ã—</button>
      </div>

      <div class="crav-messages" id="crav-messages">
        <div class="crav-message bot">
          ðŸ‘‹ Hi! I'm your AI food assistant. Tell me what you're craving and I'll recommend the perfect meal from our menu!
        </div>
      </div>

      <div class="crav-input-area">
        <div class="crav-input-container">
          <input 
            type="text" 
            class="crav-input" 
            id="crav-input" 
            placeholder="What are you craving today?"
            onkeypress="handleKeyPress(event)"
          />
          <button class="crav-send" onclick="sendMessage()" id="crav-send">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
              <path d="M2.01 21L23 12 2.01 3 2 10l15 2-15 2z"/>
            </svg>
          </button>
        </div>
      </div>
    </div>

    <!-- Auto Cart Container -->
    <div id="crav-auto-cart" class="crav-auto-cart">
      <div class="crav-cart-header">
        ðŸ›’ Recommended Items
      </div>
      <div class="crav-cart-items" id="crav-cart-items">
        <!-- Cart items will be populated here -->
      </div>
      <div class="crav-cart-actions">
        <div class="crav-cart-total" id="crav-cart-total">Select items above</div>
        <button class="crav-cart-button" onclick="addSelectedToCart()" id="add-to-cart-btn" disabled>
          Add Selected to Cart
        </button>
        <button class="crav-cart-button secondary" onclick="showMoreOptions()">
          Show More Options
        </button>
        <button class="crav-cart-button secondary" onclick="closeAutoCart()">
          Close
        </button>
      </div>
    </div>
  </div>

  <script>
    // Widget Configuration - can be overridden
    window.CravWidget = window.CravWidget || {};
    const config = {
      apiEndpoint: window.CravWidget.apiEndpoint || 'https://your-replit-url.replit.dev/api/chat',
      companyId: window.CravWidget.companyId || null,
      userId: null,
      userName: 'Guest',
      ...window.CravWidget
    };

    let isOpen = false;
    let isTyping = false;
    let messages = [];
    let autoCartItems = [];
    let selectedItems = [];

    // Initialize widget
    function initWidget() {
      // Check for authentication
      checkAuthentication();
      
      // Add welcome message based on user
      setTimeout(() => {
        if (config.userId) {
          updateUserInfo();
        }
      }, 500);
    }

    function checkAuthentication() {
      // Try to get user info from various sources
      if (window.Replit && window.Replit.auth) {
        // Replit Auth
        config.userId = window.Replit.auth.getUserId();
        config.userName = window.Replit.auth.getUserName() || 'Guest';
      } else if (window.firebase && window.firebase.auth) {
        // Firebase Auth
        const user = window.firebase.auth().currentUser;
        if (user) {
          config.userId = user.uid;
          config.userName = user.displayName || user.email || 'Guest';
        }
      } else {
        // Generate anonymous ID
        config.userId = 'widget-' + Date.now() + '-' + Math.random().toString(36).substr(2, 9);
      }
    }

    function updateUserInfo() {
      const userInfoEl = document.getElementById('crav-user-info');
      if (config.userName !== 'Guest') {
        userInfoEl.textContent = `Welcome back, ${config.userName}!`;
      }
    }

    function toggleChat() {
      const chatContainer = document.getElementById('crav-chat');
      isOpen = !isOpen;
      
      if (isOpen) {
        chatContainer.classList.add('open');
        document.getElementById('crav-input').focus();
      } else {
        chatContainer.classList.remove('open');
      }
    }

    function closeChat() {
      document.getElementById('crav-chat').classList.remove('open');
      isOpen = false;
    }

    function handleKeyPress(event) {
      if (event.key === 'Enter') {
        sendMessage();
      }
    }

    async function sendMessage() {
      const input = document.getElementById('crav-input');
      const message = input.value.trim();
      
      if (!message || isTyping) return;
      
      // Add user message
      addMessage(message, 'user');
      input.value = '';
      
      // Show typing indicator
      showTyping();
      
      try {
        const response = await fetch(config.apiEndpoint, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'X-Replit-User-Id': config.userId,
            'X-Replit-User-Name': config.userName,
            'X-Client-Id': config.companyId
          },
          body: JSON.stringify({
            messages: [{ role: 'user', content: message }]
          })
        });

        const data = await response.json();
        
        hideTyping();
        
        if (response.ok) {
          addMessage(data.response, 'bot');
          
          // Check if response contains menu recommendations and extract items
          extractMenuItems(data.response, data.menuItems);
        } else {
          addMessage('Sorry, I\'m having trouble right now. Please try again.', 'bot');
        }
      } catch (error) {
        hideTyping();
        addMessage('Sorry, I\'m having trouble connecting. Please try again.', 'bot');
        console.error('Chat error:', error);
      }
    }

    function addMessage(content, sender) {
      const messagesContainer = document.getElementById('crav-messages');
      const messageDiv = document.createElement('div');
      messageDiv.className = `crav-message ${sender}`;
      messageDiv.textContent = content;
      
      messagesContainer.appendChild(messageDiv);
      messagesContainer.scrollTop = messagesContainer.scrollHeight;
      
      messages.push({ content, sender, timestamp: new Date() });
    }

    function showTyping() {
      if (isTyping) return;
      
      isTyping = true;
      const messagesContainer = document.getElementById('crav-messages');
      const typingDiv = document.createElement('div');
      typingDiv.className = 'crav-message bot';
      typingDiv.id = 'crav-typing-indicator';
      typingDiv.innerHTML = `
        <div class="crav-typing">
          AI is thinking
          <div class="crav-typing-dots">
            <span></span>
            <span></span>
            <span></span>
          </div>
        </div>
      `;
      
      messagesContainer.appendChild(typingDiv);
      messagesContainer.scrollTop = messagesContainer.scrollHeight;
      
      // Disable send button
      document.getElementById('crav-send').disabled = true;
    }

    function hideTyping() {
      isTyping = false;
      const typingIndicator = document.getElementById('crav-typing-indicator');
      if (typingIndicator) {
        typingIndicator.remove();
      }
      
      // Enable send button
      document.getElementById('crav-send').disabled = false;
    }

    // Initialize when DOM is ready
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', initWidget);
    } else {
      initWidget();
    }

    // Extract menu items from AI response
    function extractMenuItems(response, menuItems = []) {
      autoCartItems = [];
      
      if (menuItems && menuItems.length > 0) {
        // Use menu items provided by server
        autoCartItems = menuItems;
      } else {
        // Fallback: Sample menu items for demo
        const fallbackItems = [
          { name: "Quinoa Chickpea Bowl", price: 11.99 },
          { name: "Thai Peanut Noodles", price: 12.49 },
          { name: "Sweet Potato Buddha Bowl", price: 10.99 },
          { name: "Spicy Lentil Soup", price: 9.99 },
          { name: "Miso Ginger Stir-Fry", price: 11.29 },
          { name: "Coconut Curry Chickpeas", price: 12.99 }
        ];
        
        // Find mentioned items in the response
        fallbackItems.forEach(item => {
          if (response.toLowerCase().includes(item.name.toLowerCase())) {
            autoCartItems.push(item);
          }
        });
      }
      
      // If items found, show auto cart
      if (autoCartItems.length > 0) {
        showAutoCart();
      }
    }

    function showAutoCart() {
      const autoCart = document.getElementById('crav-auto-cart');
      const cartItems = document.getElementById('crav-cart-items');
      
      // Clear existing items
      cartItems.innerHTML = '';
      selectedItems = [];
      
      // Populate cart with recommended items
      autoCartItems.forEach((item, index) => {
        const itemDiv = document.createElement('div');
        itemDiv.className = 'crav-cart-item';
        itemDiv.innerHTML = `
          <input type="checkbox" 
                 class="crav-item-checkbox" 
                 id="item-${index}" 
                 onchange="updateSelectedItems()">
          <div class="crav-item-info">
            <div class="crav-item-name">${item.name}</div>
            <div class="crav-item-price">$${item.price.toFixed(2)}</div>
          </div>
        `;
        cartItems.appendChild(itemDiv);
      });
      
      autoCart.classList.add('show');
      updateSelectedItems();
    }

    function updateSelectedItems() {
      selectedItems = [];
      let total = 0;
      
      autoCartItems.forEach((item, index) => {
        const checkbox = document.getElementById(`item-${index}`);
        if (checkbox && checkbox.checked) {
          selectedItems.push(item);
          total += item.price;
        }
      });
      
      // Update total display
      const totalElement = document.getElementById('crav-cart-total');
      const addButton = document.getElementById('add-to-cart-btn');
      
      if (selectedItems.length > 0) {
        totalElement.textContent = `Total: $${total.toFixed(2)} (${selectedItems.length} items)`;
        addButton.disabled = false;
      } else {
        totalElement.textContent = 'Select items above';
        addButton.disabled = true;
      }
    }

    function addSelectedToCart() {
      if (selectedItems.length === 0) return;
      
      // Here you would integrate with the company's cart system
      // For demo purposes, we'll show an alert and send to parent window
      const itemNames = selectedItems.map(item => item.name);
      const total = selectedItems.reduce((sum, item) => sum + item.price, 0);
      
      // Notify parent window (company's website)
      if (window.parent !== window) {
        window.parent.postMessage({
          type: 'CRAV_ADD_TO_CART',
          items: selectedItems,
          total: total
        }, '*');
      }
      
      // Show confirmation message
      addMessage(`âœ… Added ${selectedItems.length} items to cart (Total: $${total.toFixed(2)}). The company will process your order shortly!`, 'bot');
      
      // Close auto cart
      closeAutoCart();
    }

    function showMoreOptions() {
      // Request more recommendations from AI
      const input = document.getElementById('crav-input');
      input.value = 'Show me more similar options to what you just recommended';
      sendMessage();
      closeAutoCart();
    }

    function closeAutoCart() {
      const autoCart = document.getElementById('crav-auto-cart');
      autoCart.classList.remove('show');
      selectedItems = [];
      autoCartItems = [];
    }

    // Expose functions globally for integration
    window.CravWidget.open = () => {
      if (!isOpen) toggleChat();
    };
    
    window.CravWidget.close = closeChat;
    
    window.CravWidget.sendMessage = (message) => {
      document.getElementById('crav-input').value = message;
      sendMessage();
    };

    window.CravWidget.addToCart = (items) => {
      // Allow external cart integration
      return addSelectedToCart();
    };
  </script>
</body>
</html>
